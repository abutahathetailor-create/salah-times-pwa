<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" content="#1a5e63">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Salah Times">
    <link rel="apple-touch-icon" href="./icons/icon-180.png">
    <link rel="manifest" href="./manifest.json">
    <title>Salah Times - Jubail</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Your existing CSS remains the same */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        :root {
            --safe-area-inset-top: env(safe-area-inset-top, 0px);
            --safe-area-inset-bottom: env(safe-area-inset-bottom, 0px);
            --safe-area-inset-left: env(safe-area-inset-left, 0px);
            --safe-area-inset-right: env(safe-area-inset-right, 0px);
        }

        body {
            background: linear-gradient(135deg, #1a5e63 0%, #0d2a35 100%);
            color: #fff;
            min-height: 100vh;
            min-height: 100dvh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0;
            padding-top: var(--safe-area-inset-top);
            padding-bottom: var(--safe-area-inset-bottom);
            padding-left: var(--safe-area-inset-left);
            padding-right: var(--safe-area-inset-right);
        }

        .container {
            max-width: 500px;
            width: 100%;
            height: 100vh;
            height: 100dvh;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 0;
            box-shadow: 0 0 0 rgba(0, 0, 0, 0);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* ... (keep all your existing CSS styles exactly as before) ... */
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-mosque"></i> Salah Times</h1>
            <div class="date-display" id="currentDate">Loading...</div>
            <div class="hijri-date" id="hijriDate">Loading...</div>
            <div class="location">
                <i class="fas fa-map-marker-alt"></i>
                <span>Jubail, Saudi Arabia</span>
            </div>
        </div>
        
        <div class="content">
            <div id="errorMessage" style="display: none;"></div>
            
            <div class="current-time">
                <i class="fas fa-clock"></i>
                <span id="currentTime">Loading...</span>
            </div>
            
            <div class="countdown">
                <div class="countdown-title" id="countdownTitle">Next Prayer In:</div>
                <div class="countdown-timer" id="countdownTimer">--:--:--</div>
            </div>
            
            <div class="prayer-grid" id="prayerGrid">
                <div class="loading">
                    <i class="fas fa-spinner fa-spin"></i>
                    <div>Loading prayer times...</div>
                </div>
            </div>
        </div>
        
        <div class="footer">
            <p>Prayer times for Jubail, Saudi Arabia | Data from Aladhan API</p>
        </div>
    </div>

    <script>
        // Register Service Worker with GitHub Pages compatibility
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                // Use relative path for GitHub Pages
                navigator.serviceWorker.register('./sw.js')
                    .then(function(registration) {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    })
                    .catch(function(error) {
                        console.log('ServiceWorker registration failed: ', error);
                    });
            });
        }

        // Detect if we're running on GitHub Pages
        const isGitHubPages = window.location.hostname === 'github.io' || 
                             window.location.pathname.includes('github.io');

        // Jubail coordinates
        const JUBAIL_LAT = 27.0040;
        const JUBAIL_LNG = 49.6460;
        
        // DOM Elements
        const currentDateEl = document.getElementById('currentDate');
        const hijriDateEl = document.getElementById('hijriDate');
        const currentTimeEl = document.getElementById('currentTime');
        const countdownTitleEl = document.getElementById('countdownTitle');
        const countdownTimerEl = document.getElementById('countdownTimer');
        const prayerGridEl = document.getElementById('prayerGrid');
        const errorMessageEl = document.getElementById('errorMessage');
        
        // Prayer times data
        let prayerTimes = {};
        let activePrayer = '';
        let nextPrayer = '';
        let apiAttempts = 0;
        const MAX_API_ATTEMPTS = 2;
        
        // Update current time
        function updateCurrentTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit',
                hour12: true 
            });
            currentTimeEl.textContent = timeString;
            
            // Update date once a day
            if (!currentDateEl.textContent.includes(now.toLocaleDateString())) {
                updateDateInfo(now);
            }
        }
        
        // Update date information
        function updateDateInfo(date) {
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            };
            currentDateEl.textContent = date.toLocaleDateString('en-US', options);
        }
        
        // Show error message
        function showError(message) {
            errorMessageEl.innerHTML = `
                <div class="error-message">
                    <i class="fas fa-exclamation-triangle"></i>
                    <div>${message}</div>
                    <button class="retry-button" onclick="retryLoadPrayerTimes()">
                        <i class="fas fa-redo"></i> Retry
                    </button>
                </div>
            `;
            errorMessageEl.style.display = 'block';
        }
        
        // Hide error message
        function hideError() {
            errorMessageEl.style.display = 'none';
        }
        
        // Retry loading prayer times
        function retryLoadPrayerTimes() {
            hideError();
            apiAttempts = 0;
            initPrayerTimes();
        }
        
        // Fetch prayer times from API with multiple fallback methods
        async function fetchPrayerTimes() {
            const today = new Date();
            const dateString = `${today.getDate()}-${today.getMonth()+1}-${today.getFullYear()}`;
            
            // Try different API endpoints and methods
            const apiEndpoints = [
                // Direct API call
                `https://api.aladhan.com/v1/timings/${dateString}?latitude=${JUBAIL_LAT}&longitude=${JUBAIL_LNG}&method=4`,
                // With CORS proxy
                `https://corsproxy.io/?${encodeURIComponent(`https://api.aladhan.com/v1/timings/${dateString}?latitude=${JUBAIL_LAT}&longitude=${JUBAIL_LNG}&method=4`)}`,
                // Alternative CORS proxy
                `https://api.allorigins.win/raw?url=${encodeURIComponent(`https://api.aladhan.com/v1/timings/${dateString}?latitude=${JUBAIL_LAT}&longitude=${JUBAIL_LNG}&method=4`)}`
            ];
            
            for (let i = apiAttempts; i < apiEndpoints.length; i++) {
                try {
                    console.log(`Trying API endpoint ${i + 1}...`);
                    const response = await fetch(apiEndpoints[i], {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json',
                        },
                        mode: 'cors'
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    console.log('Successfully fetched prayer times');
                    return data.data;
                } catch (error) {
                    console.warn(`API attempt ${i + 1} failed:`, error);
                    if (i === apiEndpoints.length - 1) {
                        throw error;
                    }
                }
            }
            
            throw new Error('All API attempts failed');
        }
        
        // Get accurate prayer times for Jubail based on current date
        function getFallbackPrayerTimes() {
            const today = new Date();
            const month = today.getMonth() + 1;
            const day = today.getDate();
            
            // Sample prayer times for Jubail (you can adjust these as needed)
            let times;
            
            if (month >= 3 && month <= 5) { // Spring
                times = {
                    Fajr: "04:15",
                    Sunrise: "05:35",
                    Dhuhr: "11:55",
                    Asr: "15:25",
                    Maghrib: "18:15",
                    Isha: "19:45"
                };
            } else if (month >= 6 && month <= 8) { // Summer
                times = {
                    Fajr: "03:45",
                    Sunrise: "05:05",
                    Dhuhr: "11:45",
                    Asr: "15:15",
                    Maghrib: "18:35",
                    Isha: "20:05"
                };
            } else if (month >= 9 && month <= 11) { // Autumn
                times = {
                    Fajr: "04:30",
                    Sunrise: "05:50",
                    Dhuhr: "11:50",
                    Asr: "15:10",
                    Maghrib: "17:55",
                    Isha: "19:25"
                };
            } else { // Winter
                times = {
                    Fajr: "04:55",
                    Sunrise: "06:15",
                    Dhuhr: "11:45",
                    Asr: "14:55",
                    Maghrib: "17:25",
                    Isha: "18:55"
                };
            }
            
            // Calculate Hijri date
            const hijriDay = (day + 10) % 30 || 30;
            const hijriMonths = ["Muharram", "Safar", "Rabi al-Awwal", "Rabi al-Thani", "Jumada al-Awwal", "Jumada al-Thani", "Rajab", "Sha'ban", "Ramadan", "Shawwal", "Dhu al-Qadah", "Dhu al-Hijjah"];
            const hijriMonth = hijriMonths[(month + 5) % 12];
            const hijriYear = 1445; // Approximate Hijri year
            
            return {
                timings: times,
                date: {
                    hijri: {
                        day: hijriDay,
                        month: { en: hijriMonth },
                        year: hijriYear.toString()
                    }
                }
            };
        }
        
        // Initialize prayer times
        async function initPrayerTimes() {
            try {
                apiAttempts++;
                hideError();
                
                let prayerData;
                if (apiAttempts <= MAX_API_ATTEMPTS) {
                    prayerData = await fetchPrayerTimes();
                } else {
                    throw new Error('Using fallback data after multiple attempts');
                }
                
                // Update Hijri date
                const hijri = prayerData.date.hijri;
                hijriDateEl.textContent = `${hijri.day} ${hijri.month.en} ${hijri.year} AH`;
                
                // Extract prayer times
                prayerTimes = {
                    Fajr: prayerData.timings.Fajr,
                    Sunrise: prayerData.timings.Sunrise,
                    Dhuhr: prayerData.timings.Dhuhr,
                    Asr: prayerData.timings.Asr,
                    Maghrib: prayerData.timings.Maghrib,
                    Isha: prayerData.timings.Isha
                };
                
                // Display prayer times
                displayPrayerTimes();
                
                // Start countdown
                updateCountdown();
                
            } catch (error) {
                console.error('Error loading prayer times:', error);
                
                // Use fallback data
                const fallbackData = getFallbackPrayerTimes();
                prayerTimes = {
                    Fajr: fallbackData.timings.Fajr,
                    Sunrise: fallbackData.timings.Sunrise,
                    Dhuhr: fallbackData.timings.Dhuhr,
                    Asr: fallbackData.timings.Asr,
                    Maghrib: fallbackData.timings.Maghrib,
                    Isha: fallbackData.timings.Isha
                };
                
                hijriDateEl.textContent = `${fallbackData.date.hijri.day} ${fallbackData.date.hijri.month.en} ${fallbackData.date.hijri.year} AH`;
                
                displayPrayerTimes();
                updateCountdown();
                
                showError(`Using approximate prayer times. ${error.message}`);
            }
        }
        
        // Display prayer times in the grid
        function displayPrayerTimes() {
            const prayerIcons = {
                Fajr: "fas fa-sun",
                Sunrise: "fas fa-sunrise",
                Dhuhr: "fas fa-sun",
                Asr: "fas fa-sun",
                Maghrib: "fas fa-sunset",
                Isha: "fas fa-moon"
            };
            
            prayerGridEl.innerHTML = '';
            
            Object.entries(prayerTimes).forEach(([prayer, time]) => {
                const prayerCard = document.createElement('div');
                prayerCard.className = 'prayer-card';
                prayerCard.id = `prayer-${prayer}`;
                
                prayerCard.innerHTML = `
                    <div class="prayer-name">
                        <i class="${prayerIcons[prayer]}"></i>
                        <span>${prayer}</span>
                    </div>
                    <div class="prayer-time">${formatTime(time)}</div>
                `;
                
                prayerGridEl.appendChild(prayerCard);
            });
        }
        
        // Format time to 12-hour format
        function formatTime(timeString) {
            const [hours, minutes] = timeString.split(':');
            const hour = parseInt(hours);
            const ampm = hour >= 12 ? 'PM' : 'AM';
            const formattedHour = hour % 12 || 12;
            return `${formattedHour}:${minutes} ${ampm}`;
        }
        
        // Update countdown to next prayer
        function updateCountdown() {
            const now = new Date();
            const currentTime = now.getHours() * 3600 + now.getMinutes() * 60 + now.getSeconds();
            
            // Reset active prayer classes
            document.querySelectorAll('.prayer-card').forEach(card => {
                card.classList.remove('active', 'next');
            });
            
            // Find current and next prayer
            let nextPrayerName = '';
            let nextPrayerTime = null;
            let activePrayerName = '';
            
            Object.entries(prayerTimes).forEach(([prayer, time]) => {
                const [hours, minutes] = time.split(':');
                const prayerTime = parseInt(hours) * 3600 + parseInt(minutes) * 60;
                
                if (prayerTime <= currentTime) {
                    activePrayerName = prayer;
                } else if (!nextPrayerTime || prayerTime < nextPrayerTime) {
                    nextPrayerName = prayer;
                    nextPrayerTime = prayerTime;
                }
            });
            
            // If no next prayer found, use first prayer of next day
            if (!nextPrayerName) {
                nextPrayerName = 'Fajr';
                nextPrayerTime = 24 * 3600 + (parseInt(prayerTimes.Fajr.split(':')[0]) * 3600 + 
                              parseInt(prayerTimes.Fajr.split(':')[1]) * 60);
            }
            
            // Update UI
            if (activePrayerName) {
                const activeCard = document.getElementById(`prayer-${activePrayerName}`);
                if (activeCard) activeCard.classList.add('active');
            }
            
            const nextCard = document.getElementById(`prayer-${nextPrayerName}`);
            if (nextCard) nextCard.classList.add('next');
            
            // Calculate time difference
            let timeDiff = nextPrayerTime - currentTime;
            if (timeDiff < 0) timeDiff += 24 * 3600; // Add 24 hours if negative
            
            // Update countdown
            const hours = Math.floor(timeDiff / 3600);
            const minutes = Math.floor((timeDiff % 3600) / 60);
            const seconds = timeDiff % 60;
            
            countdownTitleEl.textContent = `Time until ${nextPrayerName}:`;
            countdownTimerEl.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            // Update active and next prayer variables
            activePrayer = activePrayerName;
            nextPrayer = nextPrayerName;
        }
        
        // Initialize the app
        function initApp() {
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
            
            // Show fallback data immediately while API loads
            const fallbackData = getFallbackPrayerTimes();
            prayerTimes = fallbackData.timings;
            hijriDateEl.textContent = `${fallbackData.date.hijri.day} ${fallbackData.date.hijri.month.en} ${fallbackData.date.hijri.year} AH`;
            displayPrayerTimes();
            updateCountdown();
            
            // Then try to load from API
            setTimeout(() => {
                initPrayerTimes();
            }, 1000);
            
            setInterval(updateCountdown, 1000);
            
            // Update prayer times at midnight
            const now = new Date();
            const midnight = new Date(now);
            midnight.setHours(24, 0, 0, 0);
            const timeToMidnight = midnight - now;
            
            setTimeout(() => {
                initPrayerTimes();
                // Set daily update
                setInterval(initPrayerTimes, 24 * 60 * 60 * 1000);
            }, timeToMidnight);
        }
        
        // Start the app
        window.onload = initApp;
    </script>
</body>
</html>
